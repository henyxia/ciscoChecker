#include <stdarg.h>
#include "letters.h"
#include "LCD_driver.h"

#define IMPLEMENTED_CHARS "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789?"

// Globals
int			posX=0;
int			posY=0;
const char	alphaNb[] PROGMEM = {
	37,35,20,0,//20,32,
	0,0,0,0,//29,23,26,31,
	0,0,0,0,//32,17,26,20,

	0,0,0,0,//43,44,0,0,
	0,0,0,0,
	0,0,0,0,

	0,0,0,0,
	0,0,0,0,
	0,0,0,0,

	0,0,0,0,
	0,0,0,0,
	0,0,0,0,

	0,0,0,0,
	0,0,0,0,
	0,0,0,0,

	0,0,0
};

// Letter definition
const char	letter_A[] PROGMEM = {
	0x13,0x22,0x24,0x31,0x35,0x41,0x45,0x50,0x56,0x60,
	0x66,0x70,0x71,0x72,0x73,0x74,0x75,0x76,0x80,0x81,
	0x82,0x83,0x84,0x85,0x86,0x90,0x96,0xA0,0xA6,0xB0,
	0xB6,0xC0,0xC6,0xD0,0xD6,0xE0,0xE6};
const char	letter_B[] PROGMEM = "\
\x20\x21\x22\x23\x24\x30\x35\x40\x46\x50\
\x56\x60\x66\x70\x75\x80\x81\x82\x83\x84\
\x90\x95\xA0\xA6\xB0\xB6\xC0\xC6\xD0\xD5\
\xE0\xE1\xE2\xE3\xE4";
const char	letter_C[] PROGMEM = {
	0x13,0x14,0x15,0x16,0x22,0x31,0x40,0x50,0x60,0x70,
	0x80,0x90,0xA0,0xB0,0xC1,0xD2,0xE3,0xE4,0xE5,0xE6};


const char*	const mLetter[] PROGMEM = {
	letter_A, letter_B, letter_C};


int nstrlen(char* str)
{
	//FIXME
	// Add a non infinite loop checker
	int ret = 0;
	while(str[ret] != '\0')
		ret++;

	return ret;
}

void printS(char* str)
{
	int len = nstrlen(str);
	for(int i=0; i<len; i++)
		printChar(str[i]);
}

int getIndex(char myChar)
{
	char buffer[65];
	strcpy(buffer, IMPLEMENTED_CHARS);
	//FIXME
	// Can be improved
	for(int i=0; i<IMPLEMENTED_LETTERS; i++)
		if(buffer[i] == myChar)
			return i;

	// Displaying ? as unknown
	//FIXME
	//Only 'A' is available
	return 0;
}

void printChar(char myChar)
{
	char buffer[50];

	// Searching the char
	int sChar = getIndex(myChar);

	printf("Printing char %c, index %d of len %d\n", myChar, sChar, pgm_read_byte_near(alphaNb + sChar));

	// Displaying
	for(int i=0; i<pgm_read_byte_near(alphaNb + sChar); i++)
	{
		strcpy_P(buffer, (char*)pgm_read_word(&(mLetter[sChar])));
		//LCDSetPixel(WHITE, posY + ((mLetter[sChar].table[i] & 0xF0) >> 4), posX + (mLetter[sChar].table[i] & 0x0F));
		//printf("X %02d Y%02d X %02x\n", (buffer[i] & 0xF0) >> 4, (buffer[i] & 0x0F), buffer[i]);
		LCDSetPixel(WHITE, posY + ((buffer[i] & 0xF0) >> 4), posX + (buffer[i] & 0x0F));
	}

	// Moving cursor
	posX+=8;
	if(posX>120)
	{
		posY+=16;
		posX=0;
	}
}

void addValuesToALetter(char* tLetter, int nb, ...)
{
	va_list chars;
	va_start(chars, nb);

	for(int i=0; i<nb; i++)
	{
		tLetter[i] = (char) va_arg(chars, int);
	}

	va_end(chars);
	return;
}
/*
void create_letters_table(void)
{
	mLetter[1].nb = 35;
	mLetter[2].nb = 20;
	mLetter[3].nb = 32;
	mLetter[4].nb = 29;
	mLetter[5].nb = 23;
	mLetter[6].nb = 26;
	mLetter[7].nb = 31;
	mLetter[8].nb = 32;
	mLetter[9].nb = 17;
	mLetter[10].nb = 26;
	mLetter[11].nb = 20;
	mLetter[12].nb = 43;
	mLetter[13].nb = 44;

	for(int i=0; i<IMPLEMENTED_LETTERS; i++)
	{
		mLetter[i].table = NULL;
		mLetter[i].table = malloc(sizeof(char) * (mLetter[i].nb+1));
		if(mLetter[i].table == NULL)
		{
			printf("Fail\n");
		//FIXME
		// Need to return bool here
			return;
		}
	}

	addValuesToALetter(mLetter[1].table, mLetter[1].nb,
		// 'C'
	addValuesToALetter(mLetter[2].table, mLetter[2].nb,
			0x13,0x14,0x15,0x16,0x22,0x31,0x40,0x50,0x60,0x70,
			0x80,0x90,0xA0,0xB0,0xC1,0xD2,0xE3,0xE4,0xE5,0xE6);
	// 'D'
	addValuesToALetter(mLetter[3].table, mLetter[3].nb,
			0x10,0x11,0x12,0x13,0x20,0x24,0x30,0x35,0x40,0x46,
			0x50,0x56,0x60,0x66,0x70,0x76,0x80,0x86,0x90,0x96,
			0xA0,0xA6,0xB0,0xB6,0xC0,0xC5,0xD0,0xD4,0xE0,0xE1,
			0xE2,0xE3);
	// 'E'
	addValuesToALetter(mLetter[4].table, mLetter[4].nb,
			0x20,0x21,0x22,0x23,0x24,0x25,0x26,0x30,0x40,0x50,
			0x60,0x70,0x80,0x81,0x82,0x83,0x84,0x90,0xA0,0xB0,
			0xC0,0xD0,0xE0,0xE1,0xE2,0xE3,0xE4,0xE5,0xE6);
	// 'F'
	addValuesToALetter(mLetter[5].table, mLetter[5].nb,
			0x20,0x21,0x22,0x23,0x24,0x25,0x26,0x30,0x40,0x50,
			0x60,0x70,0x80,0x81,0x82,0x83,0x84,0x90,0xA0,0xB0,
			0xC0,0xD0,0xE0);
	// 'G'
	addValuesToALetter(mLetter[6].table, mLetter[6].nb,
			0x36,0x25,0x14,0x13,0x22,0x31,0x41,0x50,0x60,0x70,
			0x80,0x90,0xA0,0xB1,0xC1,0xD2,0xE3,0xE4,0xD5,0xC6,
			0xB6,0xA6,0x96,0x86,0x85,0x84);
	// 'H'
	addValuesToALetter(mLetter[7].table, mLetter[7].nb,
			0x20,0x30,0x40,0x50,0x60,0x70,0x80,0x90,0xA0,0xB0,
			0xC0,0xD0,0xE0,0x26,0x36,0x46,0x56,0x66,0x76,0x86,
			0x96,0xA6,0xB6,0xC6,0xD6,0xE6,0x81,0x82,0x83,0x84,
			0x85);
	// 'I'
	addValuesToALetter(mLetter[8].table, mLetter[8].nb,
			0x10,0x11,0x12,0x13,0x14,0x15,0x16,0x22,0x23,0x24,
			0x33,0x43,0x53,0x63,0x73,0x83,0x93,0xA3,0xB3,0xC3,
			0xD2,0xD3,0xD4,0xE0,0xE1,0xE1,0xE2,0xE3,0xE3,0xE4,
			0xE5,0xE6);
	// 'J'
	addValuesToALetter(mLetter[9].table, mLetter[9].nb,
			0x16,0x26,0x36,0x46,0x56,0x66,0x76,0x86,0x96,0xA6,
			0xB6,0xC5,0xD4,0xE3,0xE2,0xD1,0xC0);
	// 'K'
	addValuesToALetter(mLetter[10].table, mLetter[10].nb,
			0x10,0x20,0x30,0x40,0x50,0x60,0x70,0x80,0x90,0xA0,
			0xB0,0xC0,0xD0,0xE0,0x26,0x35,0x44,0x53,0x62,0x71
			,0x81,0x92,0xA3,0xB4,0xC5,0xD6);
	// 'L'
	addValuesToALetter(mLetter[11].table, mLetter[11].nb,
			0x10,0x20,0x30,0x40,0x50,0x60,0x70,0x80,0x90,0xA0,
			0xB0,0xC0,0xD0,0xE0,0xE1,0xE2,0xE3,0xE4,0xE5,0xE6);
	// 'M'
	addValuesToALetter(mLetter[12].table, mLetter[12].nb,
			0x10,0x20,0x30,0x40,0x50,0x60,0x70,0x80,0x90,0xA0,
			0xB0,0xC0,0xD0,0xE0,0x21,0x31,0x41,0x42,0x52,0x62,
			0x63,0x73,0x83,0x44,0x54,0x64,0x25,0x35,0x45,0x16,
			0x26,0x36,0x46,0x56,0x66,0x76,0x86,0x96,0xA6,0xB6,
			0xC6,0xD6,0xE6);
	// 'N'
	addValuesToALetter(mLetter[13].table, mLetter[13].nb,
			0x10,0x20,0x30,0x40,0x50,0x60,0x70,0x80,0x90,0xA0,
			0xB0,0xC0,0xD0,0xE0,0x21,0x31,0x41,0x42,0x52,0x62,
			0x63,0x73,0x83,0x93,0x94,0xA4,0xB4,0xB5,0xC5,0xD5,
			0x16,0x26,0x36,0x46,0x56,0x66,0x76,0x86,0x96,0xA6,
			0xB6,0xC6,0xD6,0xE6);
}
*/
